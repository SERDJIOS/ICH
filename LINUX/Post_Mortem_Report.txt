
Отчёт по выполненной работе (Post Mortem)

1. Причина инцидента
Инцидент произошёл из-за нехватки свободного места на диске, что привело к невозможности записи в файл access_log. Это, в свою очередь, вызвало сбой в работе веб-сервера. Проблема была обнаружена при попытке создать временный файл, что вызвало ошибку, связанную с переполнением диска.

Для диагностики использовалась команда df -h, которая показала, что корневой раздел полностью заполнен. Команда df отображает информацию о дисковом пространстве, а ключ -h форматирует вывод в удобном для чтения виде (с единицами измерения KB, MB, GB).


2. Предпринятые шаги для восстановления сервиса

Поиск больших файлов
Для освобождения места на диске была выполнена команда:

sudo find / -type f -size +100 -exec du -h {} +

sudo — выполнение команды с правами суперпользователя.
find / — поиск файлов по всей файловой системе.
-type f — поиск только файлов.
-size +100 — файлы больше 100 блоков.
-exec du -h {} — вывод информации о размере найденных файлов в удобном формате.

В результате был найден переполненный файл access_log, а также несколько архивов, которые рекурсивно перезаписывались в той же директории, создавая дополнительные проблемы.

Очистка логов
С помощью команды sudo su был получен полный доступ к системным командам. Затем выполнена команда:

ls -al /var/log/httpd

Она отобразила список файлов в директории /var/log/httpd, где было обнаружено множество архивированных файлов.

Удаление файла:
sudo rm -f /var/log/httpd/access_log-20241210

Восстановление конфигурации
После очистки логов файл конфигурации был восстановлен:
cp LocalSettings(5).php /var/www/html/mediawiki/LocalSettings.php

Затем сервер перезапущен:
sudo service httpd restart

После перезапуска на сайте появилась переадресация на другой IP-адрес. Для исправления выполнена команда:
cat /var/www/html/mediawiki/LocalSettings.php | grep IP
С помощью редактора nano был исправлен неправильный IP-адрес, и сервер был снова перезапущен.

Анализ проблемы с access_log
Для анализа причины переполнения access_log была выполнена команда:
sudo ls -alh /var/log/httpd/
Проверка показала, что архивы снова начали появляться.

Проверка задач cron
Был проверен список задач cron:
sudo crontab -l
Обнаружена задача пользователя root, которая каждую минуту создаёт архивы в директории логов. Задача была отключена:
sudo crontab -e

Удаление архивов
Удалены все архивы .gz в директории /var/log/httpd:
sudo rm -f /var/log/httpd/*.gz

Настройка автоматической архивации
Создан скрипт для автоматического архивирования логов:
nano backup_logs.sh

Содержание скрипта:
#!/bin/bash

LOG_DIR="/var/log/httpd"
BACKUP_DIR="/home/ec2-user/backup_logs"
mkdir -p "$BACKUP_DIR"
DATE=$(date +%Y%m%d)
ARCHIVE="$BACKUP_DIR/Logs_httpd-$DATE.tar.gz"

tar -czf "$ARCHIVE" "$LOG_DIR/access_log"
sudo rm -f "$LOG_DIR/access_log"
sudo service httpd restart
find "$BACKUP_DIR" -type f -name "Logs_httpd*.gz" -mtime +3 -exec rm {} \;

Скрипт был сделан исполняемым:
chmod +x backup_logs.sh

Запущен вручную:
/backup_logs.sh

Для автоматического выполнения скрипт добавлен в crontab:
crontab -e
Запись для ежедневного запуска скрипта в полночь:
10 0 * * * /home/ec2-user/backup_logs.sh

---

 Вывод
В результате проведённых действий:
- Веб-сервер Apache успешно перезапущен, доступ к сайту восстановлен.
- Освобождено дисковое пространство путём удаления переполненных логов и архивов.
- Исправлены ошибки конфигурации приложения.
- Настроено автоматическое архивирование логов, что позволит избежать подобных проблем в будущем.

